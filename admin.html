<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>&#193;rea do administrador</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .admin-panel {
      max-width: 820px;
      margin: 0 auto;
      width: 100%;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      color: var(--ink);
    }

    .admin-table th,
    .admin-table td {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(215, 180, 106, 0.18);
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .admin-table th {
      color: var(--accent);
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .admin-table tbody tr:hover {
      background: rgba(215, 180, 106, 0.06);
    }

    .admin-table tbody tr {
      transition: background 0.2s ease;
    }

    .admin-table tbody tr.is-clickable {
      cursor: pointer;
    }

    .admin-table .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      background: rgba(215, 180, 106, 0.16);
      color: var(--accent);
      border: 1px solid rgba(215, 180, 106, 0.3);
    }

    .admin-table tr.is-paid {
      background: rgba(215, 180, 106, 0.08);
    }

    .admin-table tr.is-paid .status-pill {
      background: rgba(120, 208, 160, 0.2);
      color: #78d0a0;
      border-color: rgba(120, 208, 160, 0.4);
    }

    .mark-paid-btn {
      font-size: 0.8rem;
      padding: 8px 12px;
      min-width: 140px;
    }

    .toast {
      position: fixed;
      right: 18px;
      bottom: 20px;
      background: rgba(20, 17, 30, 0.95);
      color: var(--ink);
      border: 1px solid rgba(120, 208, 160, 0.5);
      border-radius: 14px;
      padding: 12px 16px;
      box-shadow: 0 18px 30px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transform: translateY(12px);
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 5;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid rgba(120, 208, 160, 0.6);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #78d0a0;
      font-weight: 600;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .admin-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 6;
    }

    .admin-modal.open {
      display: flex;
    }

    .admin-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(10, 8, 18, 0.7);
    }

    .admin-modal-panel {
      position: relative;
      width: min(420px, 92vw);
      background: linear-gradient(160deg, rgba(21, 17, 33, 0.98), rgba(15, 12, 23, 0.98));
      border-radius: var(--radius);
      padding: 22px;
      border: 1px solid rgba(215, 180, 106, 0.22);
      box-shadow: 0 22px 44px rgba(0, 0, 0, 0.45);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1;
    }

    .admin-modal-panel h2 {
      font-size: 1.2rem;
      color: var(--accent);
    }

    .admin-modal-subtitle {
      color: var(--muted);
      font-size: 0.92rem;
    }

    .admin-modal-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .admin-modal-form label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .admin-modal-form input {
      background: rgba(10, 8, 18, 0.85);
      border: 1px solid rgba(215, 180, 106, 0.25);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--ink);
      font-size: 0.95rem;
    }

    .admin-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .admin-form-row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }

    .admin-form-row label {
      flex: 1 1 200px;
    }

    .admin-form-row select {
      background: rgba(10, 8, 18, 0.85);
      border: 1px solid rgba(215, 180, 106, 0.25);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--ink);
      font-size: 0.95rem;
    }

    .admin-actions {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .admin-actions a {
      text-decoration: none;
      color: var(--accent);
    }

    .admin-table-wrap {
      margin-top: 16px;
      width: 100%;
      overflow-x: auto;
    }

    .parcel-summary {
      display: grid;
      gap: 6px;
      font-size: 0.92rem;
      color: var(--muted);
    }

    .parcel-summary strong {
      color: var(--ink);
      font-weight: 600;
    }

    .parcel-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }

    .parcel-table th,
    .parcel-table td {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(215, 180, 106, 0.2);
    }

    .parcel-table th {
      color: var(--accent);
      font-weight: 600;
    }

    .parcel-paid {
      color: #78d0a0;
      font-weight: 600;
    }

    .parcel-action-btn {
      font-size: 0.75rem;
      padding: 6px 10px;
    }

    .chart-card {
      margin-top: 18px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(215, 180, 106, 0.2);
      background: rgba(18, 14, 26, 0.7);
      box-shadow: 0 16px 30px var(--shadow);
    }

    .metrics-row {
      margin-top: 14px;
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }

    .metric-card {
      flex: 1 1 240px;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid rgba(215, 180, 106, 0.2);
      background: rgba(18, 14, 26, 0.75);
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 14px 26px var(--shadow);
    }

    .metric-label {
      font-size: 0.82rem;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: var(--accent);
    }

    .metric-value {
      font-size: 1.3rem;
      color: var(--accent);
      font-weight: 600;
    }

    .metric-value.received {
      color: #78d0a0;
    }

    .metric-value.to-receive {
      color: #7aa7d8;
    }

    .chart-title {
      margin: 0 0 10px;
      color: var(--accent);
      font-size: 1rem;
      font-weight: 600;
    }

    .chart-note {
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 0.85rem;
    }

    #salesChart {
      width: 100%;
      height: 180px;
      display: block;
    }

    @media (max-width: 720px) {
      .admin-table {
        font-size: 0.85rem;
      }

      .admin-table th,
      .admin-table td {
        padding: 8px 10px;
      }

      .admin-actions {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 560px) {

      .admin-table,
      .admin-table thead,
      .admin-table tbody,
      .admin-table th,
      .admin-table td,
      .admin-table tr {
        display: block;
        width: 100%;
      }

      .admin-table thead {
        display: none;
      }

      .admin-table tr {
        background: rgba(20, 17, 30, 0.78);
        border-radius: 12px;
        margin-bottom: 12px;
        padding: 8px 0;
        border: 1px solid rgba(215, 180, 106, 0.18);
      }

      .admin-table td {
        border: none;
        padding: 6px 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px 12px;
        align-items: baseline;
      }

      .admin-table td::before {
        content: attr(data-label);
        display: inline-block;
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--muted);
        margin-bottom: 0;
      }

      .chart-card {
        padding: 12px;
      }

      #salesChart {
        height: 210px;
      }

      .metrics-row {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="bg-orb orb-1"></div>
  <div class="bg-orb orb-2"></div>
  <div class="noise"></div>

  <div class="page">
    <main class="wrap">
      <div class="top-actions">
        <a class="cta-btn" href="index.html">Voltar</a>
      </div>

      <header class="hero">
        <div class="brand-mark" aria-hidden="true">
          <span class="brand-sigil"></span>
        </div>
        <p class="eyebrow">Administra&#231;&#227;o</p>
        <h1>P&#225;gina do administrador</h1>
        <p class="subtitle">Cadastre clientes e acompanhe parcelas.</p>
      </header>

      <section class="admin-panel">
        <div class="chart-card">
          <h2 class="chart-title">Grafico de vendas</h2>
          <p class="chart-note">Total vendido por dia (ultimos 7 dias, incluindo hoje).</p>
          <canvas id="salesChart" width="720" height="180" aria-label="Grafico de vendas por dia" role="img"></canvas>
        </div>
        <div class="metrics-row">
          <div class="metric-card">
            <span class="metric-label">Total a receber</span>
            <strong class="metric-value to-receive" id="totalToReceive">R$ 0,00</strong>
          </div>
          <div class="metric-card">
            <span class="metric-label">Total recebido</span>
            <strong class="metric-value received" id="totalReceived">R$ 0,00</strong>
          </div>
        </div>
      </section>

      <section class="intent admin-panel">
        <h3>Adicionar cliente</h3>
        <form id="adminClientForm" class="modal-form">
          <div class="admin-form-row">
            <label>
              Cliente
              <input type="text" name="cliente" id="cliente" placeholder="Digite aqui..." required />
            </label>
            <label>
              Quantidade de parcelas
              <select name="parcelas" id="parcelas" required>
                <option value="">Selecione</option>
                <option value="1">1x</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
                <option value="4">4x</option>
                <option value="5">5x</option>
                <option value="6">6x</option>
                <option value="7">7x</option>
                <option value="8">8x</option>
                <option value="9">9x</option>
                <option value="10">10x</option>
                <option value="11">11x</option>
                <option value="12">12x</option>
              </select>
            </label>
          </div>
          <div class="admin-form-row">
            <label>
              Valor devedor (R$)
              <input type="text" name="valor" id="valor" inputmode="numeric" placeholder="0,00" required />
            </label>
            <label>
              Forma de pagamento
              <select name="pagamento" id="pagamento" required>
                <option value="">Selecione</option>
                <option value="pix">Pix</option>
                <option value="dinheiro">Dinheiro</option>
                <option value="debito">Cart&#227;o d&#233;bito</option>
                <option value="credito">Cart&#227;o cr&#233;dito</option>
              </select>
            </label>
          </div>
          <div class="modal-actions">
            <button type="submit">Adicionar</button>
            <button type="reset" class="ghost">Limpar</button>
          </div>
        </form>
      </section>

      <section class="offerings-group admin-panel">
        <h2 class="offerings-title">Clientes cadastrados</h2>
        <div class="admin-actions">
          <p class="offerings-desc" style="margin: 0;">Lista gerada localmente no navegador.</p>
        </div>
        <div class="admin-table-wrap">
          <table class="admin-table" aria-describedby="listaClientes">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Parcelas</th>
                <th>Valor devedor</th>
                <th>Pagamento</th>
                <th>Status</th>
                <th>A&#231;&#245;es</th>
              </tr>
            </thead>
            <tbody id="clientTableBody">
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <footer class="foot">
      <p>Use esta p&#225;gina somente com autoriza&#231;&#227;o.</p>
    </footer>
  </div>

  <div class="toast" id="paidToast" role="status" aria-live="polite">
    <span class="toast-icon">&#10003;</span>
    <span id="paidToastText">Pagamento marcado.</span>
  </div>

  <div class="admin-modal" id="passwordModal" aria-hidden="true">
    <div class="admin-modal-backdrop" data-close="true"></div>
    <div class="admin-modal-panel" role="dialog" aria-modal="true" aria-labelledby="passwordTitle">
      <h2 id="passwordTitle">Confirmar pagamento</h2>
      <p class="admin-modal-subtitle">Digite a senha para marcar como pago.</p>
      <form id="passwordForm" class="admin-modal-form">
        <label>
          Senha
          <input type="password" id="passwordInput" autocomplete="current-password" required />
        </label>
        <div class="admin-modal-actions">
          <button type="submit">Confirmar</button>
          <button type="button" class="ghost" id="passwordCancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="admin-modal" id="parcelModal" aria-hidden="true">
    <div class="admin-modal-backdrop" data-close="true"></div>
    <div class="admin-modal-panel" role="dialog" aria-modal="true" aria-labelledby="parcelTitle">
      <h2 id="parcelTitle">Parcelas do cliente</h2>
      <p class="admin-modal-subtitle">Valores arredondados para fechar o total.</p>
      <div id="parcelDetails"></div>
      <div class="admin-modal-actions">
        <button type="button" class="ghost" id="parcelClose">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("adminClientForm");
    const tableBody = document.getElementById("clientTableBody");
    const valorInput = document.getElementById("valor");
    const ADMIN_PASSWORD = "34713471";
    const paidToast = document.getElementById("paidToast");
    const paidToastText = document.getElementById("paidToastText");
    const passwordModal = document.getElementById("passwordModal");
    const passwordForm = document.getElementById("passwordForm");
    const passwordInput = document.getElementById("passwordInput");
    const passwordCancel = document.getElementById("passwordCancel");
    const parcelModal = document.getElementById("parcelModal");
    const parcelDetails = document.getElementById("parcelDetails");
    const parcelClose = document.getElementById("parcelClose");
    const salesChart = document.getElementById("salesChart");
    const totalToReceive = document.getElementById("totalToReceive");
    const totalReceived = document.getElementById("totalReceived");
    let entries = [];
    let toastTimer = null;
    let pendingPaidId = null;
    let chartAnimationId = null;
    let chartAnimationStart = 0;

    function escapeHtml(value) {
      return value
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function parseMoneyToCents(value) {
      const digits = value.replace(/\D/g, "");
      return digits ? parseInt(digits, 10) : 0;
    }

    function formatMoneyFromCents(cents) {
      const integer = Math.floor(cents / 100);
      const decimals = String(cents % 100).padStart(2, "0");
      return integer.toString() + "," + decimals;
    }

    function getDayKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return year + "-" + month + "-" + day;
    }

    function getDayLabel(date) {
      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");
      return day + "/" + month;
    }

    function getLastDays(count) {
      const days = [];
      const today = new Date();
      for (let i = count - 1; i >= 0; i -= 1) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        days.push(date);
      }
      return days;
    }

    function getSalesTotals(days) {
      const totals = {};
      days.forEach((day) => {
        totals[getDayKey(day)] = 0;
      });
      entries.forEach((entry) => {
        if (!entry.pago) return;
        const stamp = typeof entry.paidAt === "number" ? entry.paidAt : entry.createdAt;
        const date = new Date(stamp || Date.now());
        const key = getDayKey(date);
        if (Object.prototype.hasOwnProperty.call(totals, key)) {
          totals[key] += entry.valorCents || 0;
        }
      });
      return days.map((day) => totals[getDayKey(day)] || 0);
    }

    function buildChartData() {
      const days = getLastDays(7);
      const totals = getSalesTotals(days);
      const maxValue = Math.max(...totals, 1);
      return { days, totals, maxValue };
    }

    function drawSalesChart(data, progress) {
      if (!salesChart) return;
      const context = salesChart.getContext("2d");
      if (!context) return;
      const width = salesChart.clientWidth;
      const height = salesChart.clientHeight;
      if (!width || !height) return;
      const ratio = window.devicePixelRatio || 1;
      salesChart.width = width * ratio;
      salesChart.height = height * ratio;
      context.setTransform(ratio, 0, 0, ratio, 0, 0);
      context.clearRect(0, 0, width, height);

      const eased = 1 - Math.pow(1 - progress, 3);
      const padding = { top: 12, right: 10, bottom: 26, left: 36 };
      const plotWidth = width - padding.left - padding.right;
      const plotHeight = height - padding.top - padding.bottom;
      const barSlot = plotWidth / data.totals.length;
      const barWidth = barSlot * 0.6;

      context.strokeStyle = "rgba(215, 180, 106, 0.2)";
      context.lineWidth = 1;
      for (let i = 0; i <= 2; i += 1) {
        const y = padding.top + (plotHeight / 2) * i;
        context.beginPath();
        context.moveTo(padding.left, y);
        context.lineTo(width - padding.right, y);
        context.stroke();
      }

      data.totals.forEach((value, index) => {
        const barHeight = ((value / data.maxValue) * plotHeight) * eased;
        const x = padding.left + index * barSlot + (barSlot - barWidth) / 2;
        const y = padding.top + (plotHeight - barHeight);
        context.fillStyle = "rgba(215, 180, 106, 0.8)";
        context.fillRect(x, y, barWidth, barHeight);
      });

      context.fillStyle = "rgba(215, 180, 106, 0.9)";
      context.font = "11px Georgia, 'Times New Roman', serif";
      context.textAlign = "center";
      context.textBaseline = "top";
      data.days.forEach((day, index) => {
        const label = getDayLabel(day);
        const x = padding.left + index * barSlot + barSlot / 2;
        context.fillText(label, x, height - padding.bottom + 6);
      });
    }

    function animateSalesChart(data) {
      if (!salesChart) return;
      if (chartAnimationId) {
        cancelAnimationFrame(chartAnimationId);
      }
      chartAnimationStart = 0;
      const duration = 600;
      const step = (timestamp) => {
        if (!chartAnimationStart) {
          chartAnimationStart = timestamp;
        }
        const progress = Math.min((timestamp - chartAnimationStart) / duration, 1);
        drawSalesChart(data, progress);
        if (progress < 1) {
          chartAnimationId = requestAnimationFrame(step);
        }
      };
      chartAnimationId = requestAnimationFrame(step);
    }

    function renderSalesChart() {
      if (!salesChart) return;
      const data = buildChartData();
      animateSalesChart(data);
    }
    function loadEntries() {
      const stored = localStorage.getItem("adminClients");
      entries = stored ? JSON.parse(stored) : [];
      entries.forEach((entry) => {
        if (typeof entry.valorCents !== "number") {
          entry.valorCents = parseMoneyToCents(entry.valor || "");
        }
        if (typeof entry.createdAt !== "number") {
          entry.createdAt = Date.now();
        }
        const parcelCount = Math.max(1, parseInt(entry.parcelas, 10) || 1);
        const isCardPayment = entry.pagamento === "debito" || entry.pagamento === "credito";
        if (isCardPayment) {
          entry.parcelPaid = new Array(parcelCount).fill(true);
          entry.pago = true;
          if (typeof entry.paidAt !== "number") {
            entry.paidAt = entry.createdAt;
          }
        } else if (parcelCount === 1) {
          entry.parcelPaid = [true];
          if (!entry.pago) {
            entry.pago = true;
          }
          if (typeof entry.paidAt !== "number") {
            entry.paidAt = entry.createdAt;
          }
        } else if (!Array.isArray(entry.parcelPaid) || entry.parcelPaid.length !== parcelCount) {
          entry.parcelPaid = new Array(parcelCount).fill(false);
        }
        if (entry.pago && typeof entry.paidAt !== "number") {
          entry.paidAt = entry.createdAt;
        }
      });
      renderEntries();
    }

    function appendRow(entry) {
      const row = document.createElement("tr");
      row.setAttribute("data-id", entry.id);
      if (entry.pago) {
        row.classList.add("is-paid");
      }
      const parcelCount = Math.max(1, parseInt(entry.parcelas, 10) || 1);
      if (parcelCount > 1) {
        row.classList.add("is-clickable");
      }
      const statusLabel = entry.pago ? "Pago" : "Pendente";
      const actionLabel = entry.pago ? "Pago" : "Marcar como finalizado";
      const canFinalize = allParcelsPaid(entry);
      const actionCell = entry.parcelas === "1"
        ? "<span class=\"status-pill\">Finalizado</span>"
        : "<button type=\"button\" class=\"ghost mark-paid-btn\" data-id=\"" + entry.id + "\"" +
          (entry.pago || !canFinalize ? " disabled" : "") + ">" + actionLabel + "</button>";
      row.innerHTML = "<td data-label=\"Cliente\">" + escapeHtml(entry.cliente) + "</td>" +
        "<td data-label=\"Parcelas\">" + escapeHtml(entry.parcelas) + "</td>" +
        "<td data-label=\"Valor devedor\">R$ " + escapeHtml(entry.valor) + "</td>" +
        "<td data-label=\"Pagamento\">" + escapeHtml(entry.pagamentoLabel) + "</td>" +
        "<td data-label=\"Status\"><span class=\"status-pill\">" + statusLabel + "</span></td>" +
        "<td data-label=\"A&#231;&#245;es\">" + actionCell + "</td>";
      tableBody.appendChild(row);
    }

    function saveEntries(entries) {
      localStorage.setItem("adminClients", JSON.stringify(entries));
    }

    function allParcelsPaid(entry) {
      const count = Math.max(1, parseInt(entry.parcelas, 10) || 1);
      if (count === 1) {
        return true;
      }
      return Array.isArray(entry.parcelPaid) && entry.parcelPaid.every((paid) => paid === true);
    }

    function buildParcelSchedule(totalCents, parcelas) {
      const count = Math.max(1, parseInt(parcelas, 10) || 1);
      const baseValue = Math.floor(totalCents / count);
      const remainder = totalCents % count;
      const schedule = [];
      for (let i = 0; i < count; i += 1) {
        schedule.push(baseValue + (i < remainder ? 1 : 0));
      }
      return schedule;
    }

    function getOutstandingCents(entry) {
      if (entry.pago) {
        return 0;
      }
      const parcelCount = Math.max(1, parseInt(entry.parcelas, 10) || 1);
      if (parcelCount === 1) {
        return entry.valorCents || 0;
      }
      const schedule = buildParcelSchedule(entry.valorCents || 0, entry.parcelas);
      let total = 0;
      for (let i = 0; i < schedule.length; i += 1) {
        if (!entry.parcelPaid || !entry.parcelPaid[i]) {
          total += schedule[i];
        }
      }
      return total;
    }

    function renderMetrics() {
      let toReceive = 0;
      let received = 0;
      entries.forEach((entry) => {
        if (entry.pago) {
          received += entry.valorCents || 0;
        } else {
          toReceive += getOutstandingCents(entry);
        }
      });
      if (totalToReceive) {
        totalToReceive.textContent = "R$ " + formatMoneyFromCents(toReceive);
      }
      if (totalReceived) {
        totalReceived.textContent = "R$ " + formatMoneyFromCents(received);
      }
    }

    function openParcelModal(entryId) {
      if (!parcelModal || !parcelDetails) return;
      const entry = entries.find((item) => item.id === entryId);
      if (!entry) return;
      const parcelCount = Math.max(1, parseInt(entry.parcelas, 10) || 1);
      if (parcelCount === 1) {
        return;
      }
      const schedule = buildParcelSchedule(entry.valorCents, entry.parcelas);
      const rows = schedule.map((amount, index) => {
        const paid = entry.parcelPaid && entry.parcelPaid[index];
        const statusCell = paid ? "<span class=\"parcel-paid\">Pago</span>" : "Pendente";
        const actionBtn = paid
          ? "<button type=\"button\" class=\"ghost parcel-action-btn\" disabled>Pago</button>"
          : "<button type=\"button\" class=\"ghost parcel-action-btn\" data-id=\"" + entry.id + "\" data-index=\"" + index + "\">Marcar como paga</button>";
        return "<tr><td>" + (index + 1) + "&ordf;</td><td>R$ " + formatMoneyFromCents(amount) + "</td><td>" + statusCell + "</td><td>" + actionBtn + "</td></tr>";
      }).join("");
      parcelDetails.innerHTML = "" +
        "<div class=\"parcel-summary\">" +
          "<p><strong>Cliente:</strong> " + escapeHtml(entry.cliente) + "</p>" +
          "<p><strong>Total:</strong> R$ " + formatMoneyFromCents(entry.valorCents) + "</p>" +
          "<p><strong>Parcelas:</strong> " + escapeHtml(entry.parcelas) + "x</p>" +
        "</div>" +
        "<table class=\"parcel-table\">" +
          "<thead><tr><th>Parcela</th><th>Valor</th><th>Status</th><th>Acoes</th></tr></thead>" +
          "<tbody>" + rows + "</tbody>" +
        "</table>";
      parcelModal.classList.add("open");
      parcelModal.setAttribute("aria-hidden", "false");
    }

    function closeParcelModal() {
      if (!parcelModal) return;
      parcelModal.classList.remove("open");
      parcelModal.setAttribute("aria-hidden", "true");
      if (parcelDetails) {
        parcelDetails.innerHTML = "";
      }
    }

    function showToast(message) {
      if (!paidToast) return;
      if (paidToastText) {
        paidToastText.textContent = message;
      }
      paidToast.classList.add("show");
      if (toastTimer) {
        clearTimeout(toastTimer);
      }
      toastTimer = setTimeout(() => {
        paidToast.classList.remove("show");
      }, 2500);
    }

    function openPasswordModal(entryId) {
      if (!passwordModal) return;
      pendingPaidId = entryId;
      passwordModal.classList.add("open");
      passwordModal.setAttribute("aria-hidden", "false");
      if (passwordInput) {
        passwordInput.value = "";
        passwordInput.focus();
      }
    }

    function closePasswordModal() {
      if (!passwordModal) return;
      passwordModal.classList.remove("open");
      passwordModal.setAttribute("aria-hidden", "true");
      pendingPaidId = null;
      if (passwordForm) {
        passwordForm.reset();
      }
    }

    function renderEntries() {
      tableBody.innerHTML = "";
      entries.forEach((entry) => {
        appendRow(entry);
      });
      renderSalesChart();
      renderMetrics();
    }

    if (form) {
      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const cliente = document.getElementById("cliente").value.trim();
        const parcelas = document.getElementById("parcelas").value.trim();
        const valor = document.getElementById("valor").value.trim();
        const pagamentoSelect = document.getElementById("pagamento");
        const pagamento = pagamentoSelect.value;
        const pagamentoLabel = pagamentoSelect.options[pagamentoSelect.selectedIndex].text;

        if (!cliente || !parcelas || !valor || !pagamento) {
          return;
        }

        const parcelCount = Math.max(1, parseInt(parcelas, 10) || 1);
        const isCardPayment = pagamento === "debito" || pagamento === "credito";
        const entry = {
          id: Date.now().toString(),
          cliente,
          parcelas,
          valor,
          valorCents: parseMoneyToCents(valor),
          pagamento,
          pagamentoLabel,
          parcelPaid: isCardPayment
            ? new Array(parcelCount).fill(true)
            : parcelCount === 1 ? [true] : new Array(parcelCount).fill(false),
          createdAt: Date.now(),
          pago: isCardPayment || parcelCount === 1
        };
        if (entry.pago) {
          entry.paidAt = entry.createdAt;
        }
        entries.push(entry);
        saveEntries(entries);
        renderEntries();
        form.reset();
      });
    }

    function formatMoneyInput(value) {
      const digits = value.replace(/\D/g, "");
      const padded = digits.padStart(3, "0");
      const cents = padded.slice(-2);
      const integer = padded.slice(0, -2);
      const integerFormatted = integer.replace(/^0+(?=\d)/, "") || "0";
      return integerFormatted + "," + cents;
    }

    if (valorInput) {
      valorInput.addEventListener("input", (event) => {
        const current = event.target.value;
        event.target.value = formatMoneyInput(current);
      });
    }

    if (tableBody) {
      tableBody.addEventListener("click", (event) => {
        const target = event.target;
        if (!target) return;
        const paidButton = target.closest(".mark-paid-btn");
        if (paidButton) {
          const id = paidButton.getAttribute("data-id");
          openPasswordModal(id);
          return;
        }
        const row = target.closest("tr");
        if (row && row.classList.contains("is-clickable") && row.getAttribute("data-id")) {
          openParcelModal(row.getAttribute("data-id"));
        }
      });
    }

    if (passwordForm) {
      passwordForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const password = passwordInput ? passwordInput.value : "";
        if (password !== ADMIN_PASSWORD) {
          alert("Senha incorreta.");
          return;
        }
        const entry = entries.find((item) => item.id === pendingPaidId);
        if (!entry || entry.pago) {
          closePasswordModal();
          return;
        }
        if (!allParcelsPaid(entry)) {
          alert("Todas as parcelas precisam estar pagas.");
          closePasswordModal();
          return;
        }
        entry.pago = true;
        entry.paidAt = Date.now();
        saveEntries(entries);
        renderEntries();
        closePasswordModal();
        showToast("Pagamento marcado como pago.");
      });
    }

    if (passwordCancel) {
      passwordCancel.addEventListener("click", () => {
        closePasswordModal();
      });
    }

    if (passwordModal) {
      passwordModal.addEventListener("click", (event) => {
        if (event.target && event.target.dataset && event.target.dataset.close === "true") {
          closePasswordModal();
        }
      });
    }

    if (parcelModal) {
      parcelModal.addEventListener("click", (event) => {
        if (event.target && event.target.dataset && event.target.dataset.close === "true") {
          closeParcelModal();
        }
      });
    }

    if (parcelClose) {
      parcelClose.addEventListener("click", () => {
        closeParcelModal();
      });
    }

    if (parcelDetails) {
      parcelDetails.addEventListener("click", (event) => {
        const target = event.target;
        if (!target) return;
        const actionButton = target.closest(".parcel-action-btn");
        if (!actionButton) return;
        const entryId = actionButton.getAttribute("data-id");
        const index = parseInt(actionButton.getAttribute("data-index"), 10);
        const entry = entries.find((item) => item.id === entryId);
        if (!entry || Number.isNaN(index)) return;
        if (!Array.isArray(entry.parcelPaid)) {
          entry.parcelPaid = [];
        }
        entry.parcelPaid[index] = true;
        saveEntries(entries);
        renderEntries();
        openParcelModal(entryId);
      });
    }

    if (salesChart) {
      window.addEventListener("resize", () => {
        renderSalesChart();
      });
    }

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && passwordModal && passwordModal.classList.contains("open")) {
        closePasswordModal();
      }
      if (event.key === "Escape" && parcelModal && parcelModal.classList.contains("open")) {
        closeParcelModal();
      }
    });

    loadEntries();
  </script>
</body>

</html>
